# Real-time Guidance Flow

**类型**: Feature  
**版本**: v1.0  
**状态**: 待实现  
**最后更新**: 2026-02-05

---

## Changelog

### v1.0 - 2026-02-05
- ✅ 接收完整功能规格文档
- 定义实时语音引导触发条件与冲突处理逻辑
- 定义语音优先级（红 > 黄 > 低）与播报策略
- 定义对比页布局（调整前 vs 调整后）与文案生成规则
- 定义从分数页到对比页的完整交互流程

---

## Implementation Log

### 理解要点

1. **核心交互**:
   - 仅在模式2（引导改进）下激活。
   - 引导包含三个阶段：准备阶段（要点总结）、录制前（心理建设）、录制中（实时反馈）。

2. **语音提示与冲突处理**:
   - **防抖逻辑**: 连续3帧检测到问题才触发播报。
   - **优先级抢占**: 高风险问题（如膝内扣）必须优先播报并可打断低优先级提示。
   - **冷却机制**: 5秒冷却时间防止语音过于频繁干扰用户。

3. **对比页可视化**:
   - 需要双视图实时渲染两个录制 session 的关键帧对比。
   - 绿色箭头 ↑ 标注改进点，属于 UI 层的后处理。

4. **文案逻辑**:
   - 采用 `[改善点] + [身体感受提示]` 格式，体现专业感和引导性。

### 实现计划

1. **语音模块**:
   - `VoiceGuidanceEngine`: 维护语音队列，处理优先级、打断逻辑和 5s 冷却时间。
2. **状态管理**:
   - 增加 `isAudioEnabled` 状态控制。
   - 实现「连续3帧」的滑动窗口检测器。
3. **对比组件**:
   - `ComparisonView`: 左右对齐的视频帧展示组件，包含差分标注逻辑。
4. **音频资源**:
   - 需准备预设的语音片段或集成 TTS。

### 待澄清问题

- 语音提示是使用预录制的音频文件还是 TTS（文字转语音）生成？(预录制更稳定，TTS 更灵活)

---

## 规格内容

# Feature Overview

实时语音引导系统，带冲突处理（仅模式2）。

## 实时引导规则（仅模式2）

### 触发条件

- 用户进入「尝试改进」
- 语音开关 = ON
- 录制中检测到问题（连续3帧 > 阈值）

## 语音冲突处理

### 优先级（降序）

1. 高风险问题（红色）：膝内扣 >15°、腰部 >45°
2. 中风险问题（黄色）：其他轻度偏差
3. 低优先级：次要检测项

### 播报策略

- 同时检测到多个问题：仅播报最高优先级
- 冷却时间：播报后 5秒内不重复
- 问题切换：新问题优先级更高时，打断当前播报

## 语音开关

- 默认：ON
- 用户可在相机页右上角关闭
- 关闭时：仅视觉引导（屏幕标注闪烁）

## 引导时机

- 准备阶段：要点总结
- 录制前：「那么现在开始」
- 录制中：静默 或 实时提示（基于检测）
- 完成：不播报（直接跳转）

## 对比页

### 布局

- 上：左右对比图（调整前 vs 调整后）
- 图上标注：绿色 ↑ 指向改进点
- 中：分数变化
    - 68 → 76  (+8)
- 下：一句话反馈
    - 「膝盖更稳了，感觉大腿外侧在发力了吗？」
    - 「腰放松了，臀部开始发力了吗？」

### 文案生成规则

**格式**：[改善点] + [身体感受提示]

## 流程入口

1. 分数页点击「尝试改进」
2. 展示引导要点卡片（基于检测结果）
3. 点击「开始」→ 重新进入相机页
4. 录制前播报引导要点
5. 录制完成 → 对比页
6. 底部按钮：「保存对比图」/「再试一次」

---

[返回主文档](../../README.md) | [查看实现跟踪](../../implementation-tracking.md)
