# Wall Squat Detection Algorithm

**类型**: Algorithm  
**版本**: v1.0  
**状态**: 待实现  
**最后更新**: 2026-02-05

---

## Changelog

### v1.0 - 2026-02-05
- ✅ 接收完整算法规格文档
- 定义三大检测项：腰部代偿、骨盆稳定性、膝关节角度
- 定义具体计算方法（基于 MediaPipe 关键点索引 11, 23, 25, 27）
- 定义分级阈值、权重与扣分逻辑
- 定义评估模式与实时模式的输出格式

---

## Implementation Log

### 理解要点

1. **核心计算逻辑**:
   - **腰部代偿 (50%)**: 最关键项。需要计算两个角度：腰椎前凸角（肩-髋 vs 垂直线）和骨盆前倾角（髋-膝 vs 垂直线）。
   - **骨盆稳定性 (30%)**: 追踪髋关节（23）的水平位移。位移需要相对于躯干长度进行归一化处理。
   - **膝关节角度 (20%)**: 计算典型的髋-膝-踝夹角。

2. **坐标系处理**:
   - 算法依赖于侧面 90° 视角。需要先将 MediaPipe 的 3D 坐标投影到 2D 平面，或直接利用 x, y 进行角度计算（需考虑人体倾斜度）。
   - 垂直线（Vertical Line）的基准：通常以重力方向（如果设备传感器可用）或图像垂直轴为准。

3. **实时逻辑**:
   - 实时模式需要极低的延迟。
   - 需要实现「触发语音」的布尔逻辑，供 F4 (Real-time Guidance Flow) 调用。

### 实现计划

1. **数学工具库**:
   - 实现 `calculateAngle(p1, p2, p3)` 函数计算夹角。
   - 实现 `calculateRelativeDisplacement(pts, referenceLength)` 计算位移。
2. **算法引擎**:
   - `WallSquatAnalyzer`: 接收帧数据，过滤噪点，执行检测。
   - 包含滑动窗口处理，用于稳定性检测和实时播报防抖。
3. **数据格式转化**:
   - 将内部计算结果转化为规格定义的 JSON 格式。

### 待澄清问题

- **骨盆前后位移**：规格中提到「髋关节（23）在垂直方向的位移变化」，但描述是「前后晃动」，结合侧面视角，这通常是指水平方向（x 轴）的变化。需确认。
- **躯干长度**：建议使用肩（11）到髋（23）的平均距离作为归一化基准。

---

## 规格内容

# 算法规格

## 输入

- 视频帧序列（MediaPipe Pose 关键点）
- 帧率：30fps
- 分析时长：保持阶段 3-5秒
- **拍摄角度**：侧面 90°

## 检测项与计算方法

### 1. 腰部代偿

**计算**：

- 侧面视角，提取：肩（11）、髋（23）、膝（25）
- 腰椎前凸角 = 髋-肩连线与垂直线夹角
- 骨盆前倾角 = 髋-膝连线与垂直线夹角

**阈值**：

| 级别 | 前凸角 | 骨盆倾斜 |
| --- | --- | --- |
| 正常 | 25-35° | <10° |
| 轻度 | 15-25° 或 35-45° | 10-20° |
| 严重 | <15° 或 >45° | >20° |

**权重**：50%

**扣分**：轻度 -15分，严重 -35分

**生物力学意义**：

- 过度前凸：髋屈肌群紧张 + 核心无力
- 前凸消失：竖脊肌代偿 + 臀部激活不足

---

### 2. 骨盆稳定性（前后晃动）

**计算**：

- 侧面视角，追踪骨盆前后位移
- 髋关节（23）在水平方向的位移变化（相对躯干长度）

**阈值**：

| 级别 | 前后位移（相对躯干长度） |  |
| --- | --- | --- |
| 正常 | <0.05 |  |
| 轻度 | 0.05-0.12 |  |
| 严重 | >0.12 |  |

**权重**：30%

**扣分**：轻度 -10分，严重 -20分

---

### 3. 膝关节过伸/屈曲不足

**计算**：

- 侧面视角，髋（23）-膝（25）-踝（27）夹角

**阈值**：

| 级别 | 膝关节角度 |  |
| --- | --- | --- |
| 正常 | 90-110° |  |
| 轻度 | 80-90° 或 110-120° |  |
| 严重 | <80° 或 >120° |  |

**权重**：20%

**扣分**：轻度 -6分，严重 -12分

## 评分公式

总分 = max(15, 100 - Σ(扣分))

**下限保护**：最低 15 分，避免过度挫败感

## 输出格式

```json
{
  "mode": "evaluation",
  "score": 72,
  "issues": [
    {
      "name": "knee_valgus",
      "severity": "moderate",
      "value": "12°",
      "weight": 40,
      "deduction": 12,
      "priority": 1
    }
  ],
  "visualization": {
    "knee_left": {"color": "yellow", "angle": 12},
    "lumbar": {"color": "green", "angle": 28}
  }
}
```

## 实时模式输出
```json
{
  "mode": "realtime",
  "frame_id": 145,
  "issues_detected": [
    {
      "name": "knee_valgus",
      "severity": "severe",
      "priority": 1,
      "trigger_voice": true,
      "value": 18
    }
  ]
}
```

---

[返回主文档](../../README.md) | [查看实现跟踪](../../implementation-tracking.md)
